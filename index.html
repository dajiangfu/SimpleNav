<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æç®€ç½‘å€å¯¼èˆª</title>
    <link rel="icon" href="icon.png" type="image/png">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="mobile-web-app-capable" content="yes">
    <script src='js/Sortable.min.js'></script>
    <style>
        :root {
            --glass: rgba(255, 255, 255, 0.25);
            --glass-hover: rgba(255, 255, 255, 0.45);
            --panel-bg: rgba(255, 255, 255, 0.9); 
            --accent: #6c5ce7;
            --text-dark: #2d3436;
            --shadow: 0 10px 30px rgba(0,0,0,0.25);
            /* è®¾å®šåŸºå‡†å®½åº¦ä»¥é…åˆç¼©æ”¾ */
            --base-width: 1200px; 
        }

        body {
            margin: 0; 
            height: 100vh; 
            width: 100vw;
            background: #2c3e50 no-repeat center center/cover;
            background-attachment: fixed;
            font-family: 'Segoe UI', 'PingFang SC', sans-serif;
            display: flex; 
            justify-content: center; 
            align-items: center;     
            overflow: hidden; 
            user-select: none;
        }

        /* 1. ç¼©æ”¾å®¹å™¨ï¼šå¼ºåˆ¶å±…ä¸­ */
        #zoomWrapper {
            display: flex; 
            flex-direction: column; 
            align-items: center;
            justify-content: center;
            width: var(--base-width); /* å›ºå®šåŸºå‡†å®½åº¦ */
            transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        /* 4. æœç´¢æ¡†ä¼˜åŒ– */
        .search-section { 
            width: 700px; /* æœç´¢æ¡†å®¹å™¨å®½åº¦ */
            z-index: 2000; 
            margin-bottom: 60px; 
            position: relative; 
        }
        
        .search-container {
            display: flex; 
            background: rgba(255,255,255,0.95); 
            border-radius: 35px; 
            padding: 6px; /* æœç´¢æ¡†å¤–æ¡†é«˜åº¦ */
            box-shadow: var(--shadow); 
            align-items: center; 
            backdrop-filter: blur(10px);
            transition: transform 0.2s;
        }
        .search-container:hover { transform: scale(1.02); }
        
        .engine-select { 
            border: none; 
            background: rgba(0,0,0,0.06); 
            padding: 10px 15px; 
            border-radius: 25px; 
            margin-right: 12px; 
            cursor: pointer; 
            outline: none; 
            font-weight: bold;
            color: #444;
            width: 140px; /* æ§åˆ¶æœç´¢æ¡†ä¸‹æ‹‰æ¡†å®½åº¦ */
            text-align-last: center; 
            font-size: 14px;
            -webkit-appearance: none;
        }
        .engine-select:hover { background: rgba(0,0,0,0.1); }
        .engine-select option { text-align: left; padding: 5px; }

        .search-container input { 
            flex: 1; 
            border: none; 
            background: transparent; 
            padding: 8px; /* æœç´¢æ¡†å†…éƒ¨è¾“å…¥æ¡†é«˜åº¦ */
            font-size: 12px; /* å­—ä½“å¤§å° */
            outline: none; 
            color: #333;
        }

        #searchHints {
            position: absolute; top: 115%; left: 0; width: 100%;
            background: var(--panel-bg); backdrop-filter: blur(20px);
            border-radius: 20px; 
            box-shadow: var(--shadow);
            display: none; 
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px; padding: 15px; box-sizing: border-box;
            max-height: 400px; overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.5);
        }

        /* 3. ä¸»ç½‘æ ¼ï¼šä¸¥æ ¼çš„ä¸€è¡Œ10ä¸ª */
        .main-grid {
            display: grid; 
            /* å¼ºåˆ¶10åˆ—ï¼Œæ¯åˆ—ç­‰å®½ */
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 30px 20px; /* è¡Œé—´è·30ï¼Œåˆ—é—´è·20 */
            padding: 20px; 
            width: 100%;
            box-sizing: border-box;
        }
        .main-grid > * {
            min-width: 0;
        }

        /* 7. åˆ†ç»„èŠ‚ç‚¹äº¤äº’ */
        .node-item { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            cursor: pointer; 
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); 
            position: relative;
        }
        .node-item:hover { transform: translateY(-10px); z-index: 10; }
        
        .icon-sphere {
            width: 85px; height: 85px; /* å›¾æ ‡å¤§å° */
            background: var(--glass);
            backdrop-filter: blur(12px); 
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid rgba(255,255,255,0.5); 
            overflow: hidden; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
            transition: all 0.3s;
        }
        .node-item:hover .icon-sphere {
            background: var(--glass-hover);
            box-shadow: 0 15px 35px rgba(0,0,0,0.25);
            border-color: #fff;
        }

        .icon-sphere img { 
            width: 100%; height: 100%; /* å›¾ç‰‡å¡«å……æ¯”ä¾‹ */
            object-fit: cover; 
            display: block;
        }
        
        /* ä¹å®«æ ¼é¢„è§ˆ */
        .preview-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            grid-template-rows: repeat(3, 1fr);
            width: 96%; height: 96%; 
            gap: 1px; padding: 12px; box-sizing: border-box;
        }
        .preview-grid img { 
            width: 100%; height: 100%; 
            border-radius: 30%; 
            object-fit: cover;
        }
        
        .label-text { 
            margin-top: 15px; 
            color: white; 
            font-size: 12px; /* åˆ†ç»„åç§°æ–‡å­—å¤§å° */
            font-weight: 600; 
            text-shadow: 0 2px 4px rgba(0,0,0,0.7); 
            text-align: center;
            max-width: 110px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        /* 2. å¼¹çª—é˜²æ­¢æº¢å‡º */
        #popover {
            position: fixed; 
            background: var(--panel-bg); 
            backdrop-filter: blur(30px) saturate(180%);
            border-radius: 24px; 
            box-shadow: 0 30px 70px rgba(0,0,0,0.5); 
            z-index: 3000; 
            display: none; 
            width: 540px; 
            max-width: calc(100vw - 32px); /* â˜… æ–°å¢ï¼Œé˜²æçª„å± */
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.7); 
            box-sizing: border-box;
            opacity: 0; transition: opacity 0.2s;
        }
        
        .pop-header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 20px; padding-bottom: 10px; 
            border-bottom: 1px solid rgba(0,0,0,0.1); 
        }
        .pop-title { font-size: 20px; font-weight: 800; color: var(--text-dark); }
        
        .pop-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); 
            gap: 20px; 
            max-height: 50vh; overflow-y: auto; 
            padding: 5px; 
        }
        .pop-grid::-webkit-scrollbar { width: 5px; }
        .pop-grid::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 3px; }

        .pop-link { 
            display: flex; flex-direction: column; align-items: center; 
            text-decoration: none; color: var(--text-dark); 
            transition: transform 0.2s;
            cursor: pointer;
        }
        .pop-link:hover { transform: translateY(-4px); }

        .pop-icon-box {
            width: 64px; height: 64px; 
            background: #fff; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 8px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.08); 
            overflow: hidden; border: 2px solid #fff;
        }
        .pop-icon-box img { width: 100%; height: 100%; object-fit: cover; }
        .pop-text { font-size: 13px; text-align: center; width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-weight: 500; }

        /* å³é”®èœå• */
        #contextMenu {
            position: fixed; display: none; z-index: 9999; 
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            border-radius: 12px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
            padding: 8px 0; min-width: 160px;
            border: 1px solid rgba(255,255,255,0.6);
            animation: fadeIn 0.1s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        .menu-item {
            padding: 10px 20px; font-size: 14px; cursor: pointer; 
            display: flex; align-items: center; gap: 10px; color: #333;
            transition: 0.1s;
        }
        .menu-item:hover { background: var(--accent); color: white; }
        .menu-separator { height: 1px; background: #eee; margin: 4px 0; }

        /* å·¥å…·æ  */
        .tools { position: fixed; bottom: 30px; right: 30px; display: flex; gap: 15px; z-index: 4000; }
        .btn-round { 
            width: 50px; height: 50px; border-radius: 50%; border: none; 
            background: rgba(255,255,255,0.2); color: white; cursor: pointer; 
            backdrop-filter: blur(10px); 
            display: flex; align-items: center; justify-content: center; 
            font-size: 22px; transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .btn-round:hover { background: var(--accent); transform: translateY(-5px); box-shadow: 0 10px 25px rgba(108, 92, 231, 0.5); }
        
        /* æç¤º */
        .toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white; padding: 10px 20px;
            border-radius: 50px; font-size: 14px; z-index: 5000;
            opacity: 0; transition: opacity 0.3s; pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="zoomWrapper">
        <div class="search-section">
            <div class="search-container">
                <select class="engine-select" id="engineSelect">
                    <option value="https://www.google.com/search?q=">Google</option>
                    <option value="https://translate.google.com/?sl=auto&tl=zh-CN&text=">Google ç¿»è¯‘</option>
                    <option value="https://www.bing.com/search?q=">Bing</option>
                    <option value="https://yandex.com/search/?text=">Yandex</option>
                    <option value="https://duckduckgo.com/?q=">DuckDuckGo</option>
                </select>
                <input type="text" id="searchInput" placeholder="æœç´¢ç½‘ç»œæˆ–ä¹¦ç­¾..." autocomplete="off">
            </div>
            <div id="searchHints"></div>
        </div>
        <div class="main-grid" id="mainGrid"></div>
    </div>

    <div id="popover">
        <div class="pop-header">
            <span class="pop-title" id="popTitle">åˆ†ç»„åç§°</span>
            <div style="font-size:12px; color:#888; background:#eee; padding:4px 10px; border-radius:10px;">
                Tip: å³é”®å›¾æ ‡å¯ä¿®æ”¹
            </div>
        </div>
        <div class="pop-grid" id="popGrid"></div>
    </div>

    <div id="contextMenu">
        <div class="menu-item" onclick="handleMenuAction('edit')">âœï¸ ä¿®æ”¹ä¿¡æ¯</div>
        <div class="menu-item" onclick="handleMenuAction('icon')">ğŸ–¼ï¸ æ›´æ¢å›¾æ ‡</div>
        <div class="menu-separator"></div>
        <div class="menu-item" onclick="handleMenuAction('delete')" style="color:#e74c3c;">ğŸ—‘ï¸ åˆ é™¤æ­¤é¡¹</div>
    </div>

    <div class="tools">
        <button class="btn-round" onclick="document.getElementById('fileInput').click()" title="å¯¼å…¥Chromeä¹¦ç­¾">ğŸ”–</button>
        <button class="btn-round" onclick="exportConfig()" title="å¯¼å‡ºé…ç½®">ğŸ“¤</button>
        <button class="btn-round" onclick="document.getElementById('configInput').click()" title="å¯¼å…¥é…ç½®">ğŸ“¥</button>
        <button class="btn-round" onclick="document.getElementById('bgInput').click()" title="æ›´æ¢å£çº¸">ğŸ¨</button>
        <button class="btn-round" onclick="openAddLinkPopup()" title="æ·»åŠ ç½‘å€">â•</button>
    </div>
    
    <div class="toast" id="toast">æ“ä½œæˆåŠŸ</div>

    <input type="file" id="fileInput" accept=".html" style="display:none">
    <input type="file" id="configInput" accept=".json" style="display:none">
    <input type="file" id="bgInput" accept="image/*" style="display:none">
    <input type="file" id="iconInput" accept="image/*" style="display:none">
    
    <div id="addLinkPopover" style="display:none; position:fixed; z-index:5000; 
        background: var(--panel-bg); backdrop-filter: blur(20px); padding:20px; border-radius:20px; 
        box-shadow: var(--shadow); width: 400px; max-width: 90vw;">
        <div style="margin-bottom:10px; font-weight:bold; font-size:16px;">æ·»åŠ æ–°ç½‘å€</div>
        <input type="text" id="newLinkName" placeholder="åç§°" style="width:100%; margin-bottom:10px; padding:8px; border-radius:8px; border:1px solid #ccc;">
        <input type="text" id="newLinkURL" placeholder="ç½‘å€ (å« https://)" style="width:100%; margin-bottom:10px; padding:8px; border-radius:8px; border:1px solid #ccc;">
    
        <select id="groupSelect" style="width:100%; padding:8px; border-radius:8px; border:1px solid #ccc; margin-bottom:10px;">
            <!-- è¿™é‡Œä¼šåŠ¨æ€ç”Ÿæˆé€‰é¡¹ï¼ŒåŒ…æ‹¬â€œæ–°å»ºåˆ†ç»„â€ -->
        </select>
    
        <input type="text" id="newGroupName" placeholder="æ–°å»ºåˆ†ç»„åç§°ï¼ˆä»…åœ¨é€‰æ‹©æ–°å»ºæ—¶å¡«å†™ï¼‰" style="width:100%; margin-bottom:10px; padding:8px; border-radius:8px; border:1px solid #ccc; display:none;">
    
        <div style="text-align:right;">
            <button onclick="closeAddLinkPopup()" style="margin-right:10px;">å–æ¶ˆ</button>
            <button onclick="addLinkToGroup()">æ·»åŠ </button>
        </div>
    </div>

<script>
    // --- æ ¸å¿ƒæ•°æ®ç»“æ„ ---
    let bData = [];
    
    // --- è¿è¡Œæ—¶çŠ¶æ€ ---
    let activeGroupIdx = -1;  // å½“å‰æ“ä½œçš„åˆ†ç»„ç´¢å¼•
    let activeLinkIdx = -1;   // å½“å‰æ“ä½œçš„é“¾æ¥ç´¢å¼• (å¦‚æœæ˜¯åˆ†ç»„æ“ä½œåˆ™ä¸º-1)
    let contextTargetType = ''; // 'group' æˆ– 'link'
    let closeTimer = null;
    let showTimer = null; // ç”¨äºæ§åˆ¶å»¶è¿Ÿæ˜¾ç¤ºçš„è®¡æ—¶å™¨
    let isDragging = false; // æ‹–æ‹½çŠ¶æ€é”
    let isMenuOpen = false;   // é˜»æ­¢å¼¹çª—å…³é—­çš„å…³é”®é”

    // --- DOM å¼•ç”¨ ---
    const els = {
        popover: document.getElementById('popover'),
        mainGrid: document.getElementById('mainGrid'),
        zoomWrapper: document.getElementById('zoomWrapper'),
        contextMenu: document.getElementById('contextMenu'),
        searchInput: document.getElementById('searchInput'),
        searchHints: document.getElementById('searchHints'),
        engineSelect: document.getElementById('engineSelect'),
        toast: document.getElementById('toast')
    };

    // --- åˆå§‹åŒ– ---
    window.onload = async () => {
        // 1. å°è¯•åŠ è½½èƒŒæ™¯å›¾
        tryLoadBackground();
        
        // 2. æ ¸å¿ƒæ•°æ®åŠ è½½é€»è¾‘ï¼šJSON > HTML > LocalStorage
        await initDataPipeline();

        // 3. æ¸²æŸ“ä¸ç¼©æ”¾
        renderMain();
        handleZoom();
        
        // 4. ç»‘å®šå…¨å±€äº‹ä»¶
        window.addEventListener('resize', handleZoom);
        document.addEventListener('click', (e) => {
            // ç‚¹å‡»ä»»æ„å¤„å…³é—­å³é”®èœå•
            if (!els.contextMenu.contains(e.target)) {
                els.contextMenu.style.display = 'none';
                isMenuOpen = false;
                
                // å¦‚æœç‚¹å‡»çš„ä¹Ÿä¸æ˜¯popoverï¼Œä¹Ÿä¸æ˜¯åˆ†ç»„å›¾æ ‡ï¼Œåˆ™å…³é—­popover
                if (!els.popover.contains(e.target) && !e.target.closest('.group-node')) {
                    hidePopoverNow();
                }
            }
        });
        
        // æ‹–æ‹½åˆå§‹åŒ–
        new Sortable(els.mainGrid, {
            animation: 200,
            ghostClass: 'sortable-ghost',
            draggable: ".group-node", // æ˜ç¡®æŒ‡å®šå¯æ‹–æ‹½çš„å…ƒç´ ç±»å
            delay: 50, // æŒ‰ä¸‹ 50ms åæ‰å¼€å§‹è¯†åˆ«ä¸ºæ‹–æ‹½ï¼Œè¿™ç»™â€œå¿«é€Ÿç‚¹å‡»â€ç•™å‡ºäº†ç©ºé—´
            delayOnTouchOnly: false,
            swapThreshold: 0.65,
            // å¼€å§‹æ‹–æ‹½æ—¶æ¸…é™¤è®¡æ—¶å™¨å¹¶ä¸Šé”
            onStart: () => {
                isDragging = true;
                clearTimeout(showTimer); 
                hidePopoverNow(); // å¦‚æœå¼¹çª—å·²ç»å¼€äº†ï¼Œå¼ºåˆ¶å…³é—­
            },
            // æ‹–æ‹½ç»“æŸæ—¶è§£é”
            onEnd: (evt) => {
                // æ‹–æ‹½ç»“æŸåï¼Œç¨ç­‰ä¸€ä¸‹å†è§£é” isDragging
                // è¿™æ ·å¯ä»¥é˜²æ­¢æ¾å¼€é¼ æ ‡çš„é‚£ä¸€ç¬é—´è¯¯è§¦å‘ onclick
                setTimeout(() => { 
                    isDragging = false; 
                    updateOrder(); // è°ƒç”¨æ›´æ–°æ’åºé€»è¾‘
                }, 100);
            }
        });
    };

    // --- 1. è‡ªé€‚åº”ç¼©æ”¾é€»è¾‘ (Point 1) ---
    function handleZoom() {
        // åŸºå‡†å®½åº¦ 1200px (å¯¹åº”8åˆ— + é—´éš™)
        const baseW = 1200; 
        const winW = window.innerWidth;
        const winH = window.innerHeight;
        
        // è®¡ç®—å®½ç¼©æ”¾æ¯”å’Œé«˜ç¼©æ”¾æ¯”
        // é¢„ç•™ä¸€äº›è¾¹è· (width * 0.9)
        const scaleX = (winW * 0.95) / baseW;
        // å‡è®¾é«˜åº¦åŸºå‡†æ˜¯ 800px
        const scaleY = (winH * 0.9) / 800; 
        
        // å–è¾ƒå°å€¼ä»¥ä¿è¯å®Œå…¨å¯è§
        let scale = Math.min(scaleX, scaleY);
        // é™åˆ¶ç¼©æ”¾èŒƒå›´ï¼Œé˜²æ­¢è¿‡å¤§æˆ–è¿‡å°
        scale = Math.max(0.5, Math.min(scale, 1.2));
        
        els.zoomWrapper.style.transform = `scale(${scale})`;
    }

    // --- æ¸²æŸ“é€»è¾‘ ---
    function renderMain() {
        els.mainGrid.innerHTML = '';
        bData.forEach((g, idx) => {
            const node = document.createElement('div');
            // ç¡®ä¿ç±»ååŒ…å« group-node ä¾› Sortable è¯†åˆ«
            node.className = 'node-item group-node';
            node.setAttribute('data-idx', idx); // å¢åŠ ç´¢å¼•æ ‡è®°
            
            // å³é”®èœå•äº‹ä»¶ (Point 3)
            node.oncontextmenu = (e) => openContextMenu(e, 'group', idx);
            
            // å¤„ç†ç‚¹å‡»å¼¹å‡º
            node.onclick = (e) => {
                // åªæœ‰å½“ä¸æ˜¯æ­£åœ¨æ‹–æ‹½ï¼Œä¸”æ²¡æœ‰æ‰“å¼€å³é”®èœå•æ—¶æ‰è§¦å‘å¼¹å‡º
                if (isDragging || isMenuOpen) return;
    
                // å¦‚æœå¼¹çª—å·²ç»å¼€äº†ï¼Œä¸”å°±æ˜¯å½“å‰è¿™ä¸ªåˆ†ç»„ï¼Œå¯ä»¥è€ƒè™‘åˆ‡æ¢å…³é—­ï¼ˆå¯é€‰ï¼‰
                if (els.popover.style.display === 'block' && activeGroupIdx === idx) {
                    hidePopoverNow();
                } else {
                    showPopover(e, idx);
                }
            };
            
            // æ‚¬åœæ˜¾ç¤ºå¼¹çª—
            node.onmouseenter = (e) => {
                if (isDragging || isMenuOpen) return; // å¦‚æœæ­£åœ¨æ‹–æ‹½ï¼Œæˆ–è€…å³é”®èœå•æ‰“å¼€ï¼Œåˆ™ä¸è§¦å‘å¼¹çª—è®¡æ—¶
                const target = e.currentTarget; // å¿…é¡»å…ˆæ•è·ç›®æ ‡ï¼Œå› ä¸ºå¼‚æ­¥åçš„ e.currentTarget ä¼šå¤±æ•ˆ
                clearTimeout(closeTimer); // å–æ¶ˆéšè—è®¡æ—¶
    
                // è®¾ç½®å»¶è¿Ÿ 500ms æ˜¾ç¤º
                showTimer = setTimeout(() => {
                    // å†æ¬¡æ£€æŸ¥ï¼Œé˜²æ­¢åœ¨ç­‰å¾…çš„0.5ç§’æœŸé—´å¼€å§‹äº†æ‹–æ‹½
                    if (!isDragging) {
                        showPopover({ currentTarget: target }, idx);
                    }
                }, 500);
            };
            node.onmouseleave = () => {
                clearTimeout(showTimer); // â˜… æ ¸å¿ƒï¼šå¦‚æœé¼ æ ‡åœ¨0.5ç§’å†…ç§»å¼€äº†ï¼Œå°±å–æ¶ˆå¼¹å‡º
                tryHidePopover();
            };

            // å›¾æ ‡æ¸²æŸ“ï¼šè‡ªå®šä¹‰å›¾ or ä¹å®«æ ¼
            let iconContent;
            if (g.customIcon) {
                iconContent = `<img src="${g.customIcon}">`;
            } else {
                const subLinks = g.links.slice(0, 9);
                const imgs = subLinks.map(l => `<img src="${l.icon}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22%23ddd%22><circle cx=%2212%22 cy=%2212%22 r=%2210%22/></svg>'">`).join('');
                iconContent = `<div class="preview-grid">${imgs}</div>`;
            }

            node.innerHTML = `
                <div class="icon-sphere" style="pointer-events: none;">${iconContent}</div>
                <div class="label-text" style="pointer-events: none;">${g.group}</div>
            `;
            // æ³¨æ„ï¼šä¸Šé¢ç»™å†…éƒ¨å…ƒç´ åŠ äº† pointer-events: noneï¼Œæ˜¯ä¸ºäº†è®©ç‚¹å‡»äº‹ä»¶ç©¿é€åˆ° node èŠ‚ç‚¹æœ¬èº«ï¼Œ
            // è¿™æ ·å¯ä»¥æå¤§æé«˜æ‹–æ‹½å’Œç‚¹å‡»çš„ç¨³å®šæ€§ã€‚
            els.mainGrid.appendChild(node);
        });
    }

    // --- 2. å¼¹çª—é€»è¾‘ (Point 2 & 3) ---
    function showPopover(e, idx) {
        if (isMenuOpen) return; // å¦‚æœæ­£åœ¨æ“ä½œå³é”®èœå•ï¼Œä¸åˆ‡æ¢å¼¹çª—
        
        activeGroupIdx = idx;
        const g = bData[idx];
        document.getElementById('popTitle').innerText = g.group; // æ›´æ–°å¼¹çª—æ ‡é¢˜ä¸ºå½“å‰åˆ†ç»„çš„åç§°
        // å…¼å®¹æ€§å¤„ç†ï¼šå¦‚æœæ˜¯ä» onclick ä¼ è¿›æ¥çš„ï¼Œç›®æ ‡æ˜¯ e.currentTarget
        // å¦‚æœæ˜¯ä» setTimeout ä¼ è¿›æ¥çš„ï¼Œä½ ä¹‹å‰å·²ç»å¤„ç†äº†å¯¹è±¡åŒ…è£…
        const targetNode = e.currentTarget; 
        if (!targetNode) return;
        
        // æ¸²æŸ“å¼¹çª—å†…å®¹
        popGrid.innerHTML = g.links.map((l, lIdx) => `
            <div class="pop-link" 
                 oncontextmenu="openContextMenu(event, 'link', ${lIdx})"
                 onclick="window.open('${l.url}','_blank')">
                <div class="pop-icon-box">
                    <img src="${l.icon}" onerror="this.src='https://www.google.com/s2/favicons?sz=64&domain=${l.url}'">
                </div>
                <div class="pop-text" title="${l.name}">${l.name}</div>
            </div>
        `).join('');
        // åˆå§‹åŒ–åˆ†ç»„å†…æ‹–æ‹½
        new Sortable(document.getElementById('popGrid'), {
            animation: 150,
            ghostClass: 'sortable-ghost',
            draggable: ".pop-link",     // æ˜ç¡®æŒ‡å®šåªæœ‰é“¾æ¥å›¾æ ‡å¯æ‹–æ‹½
            delay: 200,                // å¿…é¡»æŒ‰ä½ 200ms æ‰å¼€å§‹æ‹–æ‹½
            delayOnTouchOnly: true,    // åªåœ¨è§¦æ‘¸å±ä¸Šå¯ç”¨å»¶è¿Ÿï¼Œä¸å½±å“é¼ æ ‡æ‰‹æ„Ÿ
            touchStartThreshold: 5,    // å…è®¸ 5px çš„æ‰‹æŒ‡æŠ–åŠ¨ï¼Œé˜²æ­¢è½»å¾®æ™ƒåŠ¨å¯¼è‡´ç‚¹å‡»å¤±æ•ˆ
            onEnd: (evt) => {
                const g = bData[activeGroupIdx];
                // æ ¹æ®æ‹–æ‹½é¡ºåºé‡æ–°æ’åˆ— links
                const newLinks = [];
                const items = evt.from.children;
                for (let i = 0; i < items.length; i++) {
                    const name = items[i].querySelector('.pop-text').innerText;
                    const link = g.links.find(l => l.name === name);
                    if (link) newLinks.push(link);
                }
                g.links = newLinks;
                saveData();
            }
        });

        // è®¡ç®—ä½ç½®
        const rect = targetNode.getBoundingClientRect(); // ä½¿ç”¨ targetNode
        els.popover.style.display = 'block';
        els.popover.style.opacity = '0';
        
        // ç¡®ä¿å¼¹çª—å·²æ¸²æŸ“ä»¥è·å–å°ºå¯¸
        requestAnimationFrame(() => {
            const padding = 16;
            const pW = els.popover.offsetWidth;
            const pH = els.popover.offsetHeight;
            // ç†æƒ³å±…ä¸­
            let left = rect.left + rect.width / 2 - pW / 2;
            let top  = rect.bottom + 15;

            // æ¨ªå‘å¤¹ç´§ï¼ˆæœ€ç»ˆï¼‰
            left = Math.max(
                padding,
                Math.min(left, window.innerWidth - pW - padding)
            );
            // çºµå‘ï¼šä¸‹æ–¹ä¸å¤Ÿåˆ™æ”¾ä¸Šæ–¹
            if (top + pH + padding > window.innerHeight) {
                top = rect.top - pH - 15;
            }
            // â˜… çºµå‘æœ€ç»ˆå¤¹ç´§ï¼ˆä½ ä¹‹å‰ç¼ºçš„å…³é”®ä¸€æ­¥ï¼‰
            top = Math.max(
                padding,
                Math.min(top, window.innerHeight - pH - padding)
            );

            els.popover.style.left = `${left}px`;
            els.popover.style.top  = `${top}px`;
            els.popover.style.opacity = '1';
        });
    }

    function tryHidePopover() {
        // Point 3: å¦‚æœèœå•æ‰“å¼€ï¼Œç»å¯¹ä¸éšè—
        if (isMenuOpen) return;
        
        closeTimer = setTimeout(() => {
            els.popover.style.opacity = '0';
            setTimeout(() => {
                // åŒé‡æ£€æŸ¥ï¼Œé˜²æ­¢åœ¨æ·¡å‡ºåŠ¨ç”»æ—¶åˆç§»å…¥
                if (els.popover.style.opacity === '0') els.popover.style.display = 'none';
            }, 200);
        }, 300);
    }
    
    function openAddLinkPopup() {
        const pop = document.getElementById('addLinkPopover');
        pop.style.display = 'block';

        // å¡«å……åˆ†ç»„ä¸‹æ‹‰æ¡†
        const sel = document.getElementById('groupSelect');
        sel.innerHTML = '';
        bData.forEach((g, idx) => {
            const opt = document.createElement('option');
            opt.value = idx;
            opt.textContent = g.group;
            sel.appendChild(opt);
        });
        const newOpt = document.createElement('option');
        newOpt.value = 'new';
        newOpt.textContent = 'æ–°å»ºåˆ†ç»„';
        sel.appendChild(newOpt);

        // æ§åˆ¶æ–°å»ºåˆ†ç»„è¾“å…¥æ¡†æ˜¾ç¤º
        sel.onchange = () => {
            document.getElementById('newGroupName').style.display = sel.value === 'new' ? 'block' : 'none';
        };

        // é»˜è®¤éšè—æ–°å»ºåˆ†ç»„è¾“å…¥æ¡†
        document.getElementById('newGroupName').style.display = 'none';
    }

    function closeAddLinkPopup() {
        const pop = document.getElementById('addLinkPopover');
        pop.style.display = 'none';
        document.getElementById('newLinkName').value = '';
        document.getElementById('newLinkURL').value = '';
        document.getElementById('newGroupName').value = '';
    }
    
    function addLinkToGroup() {
        const name = document.getElementById('newLinkName').value.trim();
        const url = document.getElementById('newLinkURL').value.trim();
        const groupSel = document.getElementById('groupSelect').value;
        const newGroupName = document.getElementById('newGroupName').value.trim();

        if(!name || !url) { showToast("åç§°å’Œç½‘å€ä¸èƒ½ä¸ºç©º"); return; }

        let groupIdx;
        if(groupSel === 'new') {
            if(!newGroupName) { showToast("è¯·å¡«å†™æ–°åˆ†ç»„åç§°"); return; }
            const newGroup = { group: newGroupName, links: [], customIcon: null };
            bData.push(newGroup);
            groupIdx = bData.length - 1;
        } else {
            groupIdx = parseInt(groupSel);
        }

        // æ·»åŠ é“¾æ¥
        let icon;
        try { 
            const u = new URL(url);
            icon = `https://www.google.com/s2/favicons?sz=64&domain=${u.hostname}`;
        } catch(e) { icon = ''; }

        bData[groupIdx].links.push({ name, url, icon });

        saveData();
        renderMain();
        if(activeGroupIdx === groupIdx) refreshPopover(); // å¦‚æœå¼¹çª—æ‰“å¼€ï¼Œåˆ·æ–°å†…å®¹

        showToast("æ·»åŠ æˆåŠŸ");
        closeAddLinkPopup();
    }
    
    function hidePopoverNow() {
        clearTimeout(closeTimer);
        els.popover.style.display = 'none';
        els.popover.style.opacity = '0';
    }

    els.popover.onmouseenter = () => clearTimeout(closeTimer);
    els.popover.onmouseleave = tryHidePopover;

    // --- 3. ç»Ÿä¸€å³é”®èœå•é€»è¾‘ (Point 3) ---
    function openContextMenu(e, type, idx) {
        e.preventDefault();
        e.stopPropagation();
        
        isMenuOpen = true; // é”å®šå¼¹çª—ä¸æ¶ˆå¤±
        contextTargetType = type; // 'group' or 'link'
        
        if (type === 'group') {
            activeGroupIdx = idx;
            activeLinkIdx = -1;
        } else {
            // åœ¨å¼¹çª—é‡Œçš„linkè¢«ç‚¹å‡»ï¼ŒactiveGroupIdx å·²ç»åœ¨ showPopover æ—¶è®¾ç½®å¥½äº†
            activeLinkIdx = idx;
        }
        
        // èœå•å®šä½é˜²æº¢å‡º
        const menu = els.contextMenu;
        menu.style.display = 'block';
        let x = e.clientX;
        let y = e.clientY;
        
        if (x + 160 > window.innerWidth) x -= 160;
        if (y + 120 > window.innerHeight) y -= 120;
        
        menu.style.left = `${x}px`;
        menu.style.top = `${y}px`;
    }

    function handleMenuAction(action) {
        els.contextMenu.style.display = 'none';
        isMenuOpen = false;
    
        if (action === 'edit' || action === 'rename') {
            if (contextTargetType === 'group') {
                // åˆ†ç»„åªéœ€ä¿®æ”¹åç§°
                const oldName = bData[activeGroupIdx].group;
                const newGroupName = prompt("è¯·è¾“å…¥æ–°çš„åˆ†ç»„åç§°:", oldName);
                if (newGroupName && newGroupName.trim() !== "") {
                    bData[activeGroupIdx].group = newGroupName.trim();
                    saveData();
                    renderMain();
                }
            } else {
                // é“¾æ¥ä¿®æ”¹ï¼šåç§° + ç½‘å€
                const link = bData[activeGroupIdx].links[activeLinkIdx];
            
                // ç¬¬ä¸€æ­¥ï¼šä¿®æ”¹åç§°
                const newName = prompt("1/2 ä¿®æ”¹åç§°:", link.name);
                if (newName !== null) { // ç”¨æˆ·æ²¡ç‚¹å–æ¶ˆ
                
                    // ç¬¬äºŒæ­¥ï¼šä¿®æ”¹ç½‘å€
                    const newUrl = prompt("2/2 ä¿®æ”¹ç½‘å€:", link.url);
                    if (newUrl !== null) { // ç”¨æˆ·æ²¡ç‚¹å–æ¶ˆ
                    
                        // æ›´æ–°æ•°æ®
                        link.name = newName.trim() || link.name;
                        link.url = newUrl.trim() || link.url;
                    
                        // æ ¸å¿ƒï¼šå¦‚æœç½‘å€å˜äº†ï¼Œå°è¯•è‡ªåŠ¨æ›´æ–°å›¾æ ‡ (å¯é€‰ï¼Œå»ºè®®ä¿ç•™)
                        if (newUrl.trim() !== "") {
                            try {
                                const u = new URL(link.url);
                                // åªæœ‰å½“ç”¨æˆ·æ²¡æœ‰è‡ªå®šä¹‰è¿‡æœ¬åœ°å›¾æ ‡æ—¶ï¼Œæ‰è‡ªåŠ¨æŠ“å– Google Favicon
                                if (!link.icon.startsWith('data:image')) {
                                    link.icon = `https://www.google.com/s2/favicons?sz=64&domain=${u.hostname}`;
                                }
                            } catch(e) { console.warn("ç½‘å€æ ¼å¼ä¸æ­£ç¡®ï¼Œæ— æ³•è‡ªåŠ¨æ›´æ–°å›¾æ ‡"); }
                        }

                        saveData();       // ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜
                        refreshPopover(); // åˆ·æ–°å½“å‰å¼¹çª—å†…å®¹
                        showToast("ä¿¡æ¯ä¿®æ”¹æˆåŠŸ");
                    }
                }
            }
        }
        else if (action === 'icon') {
            // è§¦å‘éšè—çš„æ–‡ä»¶è¾“å…¥æ¡†
            document.getElementById('iconInput').click();
        }
        else if (action === 'delete') {
            if (confirm("ç¡®å®šåˆ é™¤å—ï¼Ÿ")) {
                if (contextTargetType === 'group') {
                    bData.splice(activeGroupIdx, 1);
                    hidePopoverNow();
                    saveData();
                    renderMain();
                } else {
                    bData[activeGroupIdx].links.splice(activeLinkIdx, 1);
                    saveData();
                    refreshPopover();
                }
            }
        }
    }

    // å¤„ç†å›¾æ ‡ä¸Šä¼ 
    document.getElementById('iconInput').onchange = (e) => {
        if (!e.target.files.length) return;
        const file = e.target.files[0];
        const maxSize = 30 * 1024; // å›¾æ ‡ 30KB é™åˆ¶
        // --- æ£€æŸ¥å›¾æ ‡æ–‡ä»¶å¤§å° ---
        if (file.size > maxSize) {
            alert(`å›¾ç‰‡å¤ªå¤§å•¦ï¼å½“å‰å¤§å°ï¼š${(file.size / 1024).toFixed(1)}KBï¼Œè¯·ä¸Šä¼ å°äº 30KB çš„å›¾ç‰‡ã€‚`);
            e.target.value = ''; // æ¸…ç©ºé€‰æ‹©
            return;
        }
        const reader = new FileReader();
        reader.onload = (ev) => {
            const res = ev.target.result;
            // è¿™é‡Œçš„ res æ˜¯ Base64 å­—ç¬¦ä¸²
            if (contextTargetType === 'group') {
                bData[activeGroupIdx].customIcon = res;
                renderMain();
            } else {
                bData[activeGroupIdx].links[activeLinkIdx].icon = res;
                refreshPopover();
            }
            saveData();
            e.target.value = ''; // é‡ç½®ä»¥ä¾¿é‡å¤è§¦å‘
            showToast("å›¾æ ‡è®¾ç½®æˆåŠŸ");
        };
        reader.readAsDataURL(e.target.files[0]);
    };

    function refreshPopover() {
        // é‡æ–°æ¸²æŸ“å½“å‰æ‰“å¼€çš„å¼¹çª—
        if (activeGroupIdx > -1) {
            // æ¨¡æ‹Ÿä¸€æ¬¡äº‹ä»¶å¯¹è±¡æ¥è°ƒç”¨ showPopover æ¯”è¾ƒéº»çƒ¦ï¼Œ
            // ç›´æ¥æ›´æ–°å†…å®¹æ›´é«˜æ•ˆ
            const g = bData[activeGroupIdx];
            const popGrid = document.getElementById('popGrid');
            popGrid.innerHTML = g.links.map((l, lIdx) => `
                <div class="pop-link" 
                     oncontextmenu="openContextMenu(event, 'link', ${lIdx})"
                     onclick="window.open('${l.url}','_blank')">
                    <div class="pop-icon-box">
                        <img src="${l.icon}">
                    </div>
                    <div class="pop-text">${l.name}</div>
                </div>
            `).join('');
            // åˆå§‹åŒ–æ‹–æ‹½
            new Sortable(popGrid, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                draggable: ".pop-link",     // æ˜ç¡®æŒ‡å®šåªæœ‰é“¾æ¥å›¾æ ‡å¯æ‹–æ‹½
                delay: 200,                // å¿…é¡»æŒ‰ä½ 200ms æ‰å¼€å§‹æ‹–æ‹½
                delayOnTouchOnly: true,    // åªåœ¨è§¦æ‘¸å±ä¸Šå¯ç”¨å»¶è¿Ÿï¼Œä¸å½±å“é¼ æ ‡æ‰‹æ„Ÿ
                touchStartThreshold: 5,    // å…è®¸ 5px çš„æ‰‹æŒ‡æŠ–åŠ¨ï¼Œé˜²æ­¢è½»å¾®æ™ƒåŠ¨å¯¼è‡´ç‚¹å‡»å¤±æ•ˆ
                onEnd: (evt) => {
                    const newLinks = [];
                    const items = evt.from.children;
                    for (let i = 0; i < items.length; i++) {
                        const name = items[i].querySelector('.pop-text').innerText;
                        const link = g.links.find(l => l.name === name);
                        if (link) newLinks.push(link);
                    }
                    g.links = newLinks;
                    saveData();
                }
            });
        }
    }

    // --- 4. æœç´¢åŠŸèƒ½ (Point 4) ---
    els.engineSelect.onchange = () => localStorage.setItem('nav_pro_engine', els.engineSelect.value);
    
    els.searchInput.oninput = (e) => {
        const kw = e.target.value.trim().toLowerCase();
        if (!kw) { els.searchHints.style.display = 'none'; return; }
        
        let res = [];
        bData.forEach(g => g.links.forEach(l => { 
            if (l.name.toLowerCase().includes(kw) || l.url.includes(kw)) res.push(l); 
        }));
        
        if (res.length > 0) {
            els.searchHints.innerHTML = res.slice(0, 8).map(l => `
                <div style="display:flex; align-items:center; padding:8px; cursor:pointer; border-radius:8px;" 
                     class="menu-item" onclick="window.open('${l.url}','_blank')">
                    <img src="${l.icon}" style="width:24px; height:24px; border-radius:50%; margin-right:10px;">
                    <span style="font-size:14px; color:#333; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${l.name}</span>
                </div>
            `).join('');
            els.searchHints.style.display = 'grid';
        } else {
            els.searchHints.style.display = 'none';
        }
    };
    
    els.searchInput.onkeydown = (e) => {
        if (e.key === 'Enter') {
            if (els.searchInput.value) {
                window.open(els.engineSelect.value + encodeURIComponent(els.searchInput.value), '_blank');
            }
            els.searchHints.style.display = 'none';
        }
    };

    // --- 6. ä¹¦ç­¾å¯¼å…¥ (Point 6 - é‡å†™) ---
    // é€’å½’éå† DOM æ ‘æå–é“¾æ¥
    function traverseBookmarks(element, currentGroup, results) {
        const children = Array.from(element.children);
        
        children.forEach(child => {
            const tagName = child.tagName.toUpperCase();
            
            if (tagName === 'H3') {
                // å‘ç°æ–°åˆ†ç»„
                currentGroup = {
                    group: child.textContent.trim() || 'æœªå‘½å',
                    links: [],
                    customIcon: null
                };
                results.push(currentGroup);
            } 
            else if (tagName === 'A') {
                // å‘ç°é“¾æ¥
                if (currentGroup) {
                    let icon = child.getAttribute('icon');
                    if(!icon) {
                        try {
                            const u = new URL(child.href);
                            icon = `https://www.google.com/s2/favicons?sz=64&domain=${u.hostname}`;
                        } catch(e) { icon = ''; }
                    }
                    currentGroup.links.push({
                        name: child.textContent.trim(),
                        url: child.href,
                        icon: icon
                    });
                }
            } 
            else if (tagName === 'DL' || tagName === 'DT' || tagName === 'P') {
                // ç»§ç»­æ·±å…¥
                traverseBookmarks(child, currentGroup, results);
            }
        });
    }

    document.getElementById('fileInput').onchange = (e) => {
        if (!e.target.files.length) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(ev.target.result, 'text/html');
            const results = [];
        
            traverseBookmarks(doc.body, null, results);
        
            // è¿‡æ»¤ç©ºåˆ†ç»„
            let validGroups = results.filter(g => g.links.length > 0);

            if (validGroups.length > 0) {
                let addedGroupCount = 0;
                let addedLinkCount = 0;

                validGroups.forEach(newGroup => {
                    // æ£€æŸ¥ bData æ˜¯å¦å·²æœ‰åŒååˆ†ç»„
                    const existingGroup = bData.find(g => g.group === newGroup.group);
                
                    if (existingGroup) {
                        // åˆ†ç»„å­˜åœ¨ï¼Œè¿½åŠ æ–°é“¾æ¥ï¼ˆå»é‡ URLï¼‰
                        newGroup.links.forEach(l => {
                            if (!existingGroup.links.some(el => el.url === l.url)) {
                                existingGroup.links.push(l);
                                addedLinkCount++;
                            }
                        });
                    } else {
                        // æ–°åˆ†ç»„ï¼Œç›´æ¥æ·»åŠ 
                        bData.push(newGroup);
                        addedGroupCount++;
                        addedLinkCount += newGroup.links.length;
                    }
                });

                saveData();
                renderMain();
                showToast(`å¯¼å…¥å®Œæˆï¼šæ–°å¢ ${addedGroupCount} ä¸ªåˆ†ç»„ï¼Œæ–°å¢ ${addedLinkCount} ä¸ªé“¾æ¥`);
            } else {
                alert('æœªæ‰¾åˆ°æœ‰æ•ˆä¹¦ç­¾ï¼Œè¯·ç¡®è®¤æ–‡ä»¶æ ¼å¼ã€‚');
            }
        };
        reader.readAsText(e.target.files[0]);
        e.target.value = '';
    };


    // --- 5. é…ç½®å¯¼å…¥å¯¼å‡º (Point 5) ---
    function exportConfig() {
        const config = {
            version: "3.0",
            data: bData,
            bg: localStorage.getItem('nav_pro_bg'),
            engine: els.engineSelect.value
        };
        const blob = new Blob([JSON.stringify(config)], {type: "application/json"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `Minimalist_Config_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
    }

    document.getElementById('configInput').onchange = (e) => {
        if (!e.target.files.length) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            try {
                const c = JSON.parse(ev.target.result);
                if (c.data && Array.isArray(c.data)) {
                    if(confirm("å¯¼å…¥å°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ï¼Œç¡®å®šå—ï¼Ÿ")) {
                        bData = c.data;
                        if(c.bg) {
                            localStorage.setItem('nav_pro_bg', c.bg);
                            document.body.style.backgroundImage = `url(${c.bg})`;
                        }
                        if(c.engine) {
                            localStorage.setItem('nav_pro_engine', c.engine);
                            els.engineSelect.value = c.engine;
                        }
                        saveData();
                        renderMain();
                        showToast("é…ç½®è¿˜åŸæˆåŠŸ");
                    }
                } else {
                    alert("é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯");
                }
            } catch(err) { alert("æ–‡ä»¶è§£æå¤±è´¥"); }
        };
        reader.readAsText(e.target.files[0]);
        e.target.value = '';
    };

    // èƒŒæ™¯å›¾(é™åˆ¶ 1MB)
    document.getElementById('bgInput').onchange = (e) => {
        if (!e.target.files.length) return;
        const file = e.target.files[0];
        const maxBgSize = 1024 * 1024; // 1MB
        if (file.size > maxBgSize) {
            alert(`èƒŒæ™¯å›¾å¤ªå¤§äº†ï¼å½“å‰å¤§å°ï¼š${(file.size / 1024 / 1024).toFixed(1)}MBï¼Œè¯·å‹ç¼©è‡³ 1MB ä»¥å†…ï¼Œå¦åˆ™æµè§ˆå™¨å¯èƒ½æ— æ³•ä¿å­˜æ‚¨çš„è®¾ç½®ã€‚`);
            e.target.value = '';
            return;
        }
        const reader = new FileReader();
        reader.onload = (ev) => {
            document.body.style.backgroundImage = `url(${ev.target.result})`;
            localStorage.setItem('nav_pro_bg', ev.target.result); // è¿™é‡Œä¿å­˜äº†å¤§å›¾
            showToast("å£çº¸è®¾ç½®æˆåŠŸ");
        };
        reader.readAsDataURL(file);
    };

    // --- è¾…åŠ©å‡½æ•° ---
    function saveData() {
        try {
            localStorage.setItem('nav_elite_data', JSON.stringify(bData));
        } catch(e) {
            alert("æ•°æ®è¿‡å¤§(å›¾ç‰‡è¿‡å¤š)ï¼Œå¯èƒ½æ— æ³•ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜ï¼Œå»ºè®®å¯¼å‡ºé…ç½®æ–‡ä»¶å¤‡ä»½ã€‚");
        }
    }

    function updateOrder() {
        if (!bData || bData.length === 0) return;
        const newData = [];
        // æŒ‰ç…§æ‹–æ‹½åçš„ DOM é¡ºåºé‡æ–°æŠ“å–æ•°æ®
        const nodes = els.mainGrid.querySelectorAll('.group-node');
        nodes.forEach(node => {
            const idx = node.getAttribute('data-idx');
            if (idx !== null) {
                newData.push(bData[parseInt(idx)]);
            }
        });
        // æ›´æ–°æ•°æ®å¹¶é‡æ–°æ¸²æŸ“ä¸€æ¬¡ï¼ˆé‡ç½® data-idxï¼‰
        bData = newData;
        saveData();
        renderMain();
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.style.opacity = '1';
        setTimeout(() => t.style.opacity = '0', 2000);
    }
    
    // --- è‡ªåŠ¨åŒ–æ•°æ®åŠ è½½é€»è¾‘ ---
    async function initDataPipeline() {
        // ä¼˜å…ˆçº§ 1: è¯»å–æµè§ˆå™¨ç¼“å­˜ (LocalStorage)
        const stored = localStorage.getItem('nav_elite_data');
        if (stored) {
            try { 
                bData = JSON.parse(stored); 
                console.log("âœ… å­˜åœ¨ç¼“å­˜ï¼šä»æœ¬åœ°ç¼“å­˜åŠ è½½æ•°æ®");
                return; // å‘½ä¸­ç¼“å­˜ï¼Œç›´æ¥è·³å‡ºï¼Œä¸å†è¯»å–åŸå§‹æ–‡ä»¶
            } catch(e) { console.error("è§£æç¼“å­˜å¤±è´¥:", e); }
        }
        // ä¼˜å…ˆçº§ 2: å°è¯•åŠ è½½ JSON é…ç½®æ–‡ä»¶
        const jsonPath = 'data/Minimalist_Config.json';
        try {
            const response = await fetch(jsonPath);
            if (response.ok) {
                const config = await response.json();
                if (config.data) {
                    bData = config.data;
                    if (config.engine) els.engineSelect.value = config.engine;
                    console.log("âœ… é¦–æ¬¡å¯åŠ¨ï¼šä» JSON è‡ªåŠ¨å¯¼å…¥æ•°æ®");
                    return; // æˆåŠŸåˆ™è·³å‡º
                }
            }
        } catch (e) { console.warn("æœªæ‰¾åˆ° JSON é…ç½®æ–‡ä»¶æˆ–è§£æå¤±è´¥"); }

        // ä¼˜å…ˆçº§ 3: å°è¯•åŠ è½½ Chrome ä¹¦ç­¾ HTML
        const htmlPath = 'data/bookmarks.html';
        try {
            const response = await fetch(htmlPath);
            if (response.ok) {
                const htmlText = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlText, 'text/html');
                const results = [];
                traverseBookmarks(doc.body, null, results);
                let validGroups = results.filter(g => g.links.length > 0);
                if (validGroups.length > 0) {
                    bData = validGroups; // è¦†ç›–åˆå§‹æ•°æ®
                    console.log("âœ… é¦–æ¬¡å¯åŠ¨ï¼šä» HTML è‡ªåŠ¨å¯¼å…¥ä¹¦ç­¾");
                    return;
                }
            }
        } catch (e) { console.warn("æœªæ‰¾åˆ°ä¹¦ç­¾ HTML æ–‡ä»¶"); }
    }

    // è‡ªåŠ¨åŠ è½½èƒŒæ™¯å›¾
    function tryLoadBackground() {
        // ä¼˜å…ˆçº§ 1: å…ˆçœ‹ç¼“å­˜é‡Œæœ‰æ²¡æœ‰æ‰‹åŠ¨è®¾ç½®è¿‡çš„å£çº¸ (Base64)
        const cachedBg = localStorage.getItem('nav_pro_bg');
        if (cachedBg) {
            document.body.style.backgroundImage = `url(${cachedBg})`;
            console.log("âœ… ä½¿ç”¨æ‰‹åŠ¨è®¾ç½®çš„ä¸ªæ€§åŒ–å£çº¸");
            return;
        }

        // ä¼˜å…ˆçº§ 2: å¦‚æœæ²¡æœ‰æ‰‹åŠ¨è®¾ç½®ï¼ŒåŠ è½½ data æ–‡ä»¶å¤¹é‡Œçš„é»˜è®¤èƒŒæ™¯
        const bgPath = 'data/Background.jpg';
        // å…ˆæ£€æŸ¥ data ç›®å½•ä¸‹æ˜¯å¦æœ‰å›¾
        const img = new Image();
        img.src = bgPath;
        img.onload = () => {
            document.body.style.backgroundImage = `url(${bgPath})`;
            console.log("âœ… æˆåŠŸåŠ è½½æœ¬åœ°èƒŒæ™¯å›¾");
        };
        img.onerror = () => {
            console.log("â„¹ï¸ æœªå‘ç°é»˜è®¤å£çº¸ï¼Œä½¿ç”¨ CSS é»˜è®¤åº•è‰²");
        };
    }
</script>
</body>
</html>